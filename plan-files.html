<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Imagery CSS -->
    <link href="assets/css/main.css" rel="stylesheet">

    <!--JQuery javascript-->
    <script src="assets/js/jquery.min.js"></script>
    <!--Slick javascript-->
    <script src="assets/slick/slick.min.js"></script>

    <title>Zed Designs</title>
  </head>
  <body>
  
    <nav class="navbar">
        <ul class="nav">
            <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
            <li class="nav-item"><a href="plans.html" class="nav-link">Plans</a></li>
        </ul>
    </nav>

    <div class="container">
        
        <div class="card">
            <img id="plan-picture" src="assets/images/sunset-in-the-mountains.png">
            <div class="body">
                <ul class="list">
                    <li class="item">ID: <span class="text-sale-id"></span></li>
                    <li class="item">PHONE: <span class="text-sale-phone"></span></li>
                    <li class="item">STATUS: <span class="text-sale-status"></span></li>
                </ul>
                <hr>
                <table class="table">
                    <tr>
                        <th>ID</th>
                        <th>File</th>
                        <th></th>
                    </tr>
                    <tbody id="plan-files"></tbody>
                </table>
            </div>
        </div>

      <div class="row" id="plan-pictures"></div>

    </div>
    <script>
    var access_code = "";
    var url = location.search;
    var paramstr = url.substring(1);
    var paramarr = paramstr.split("&");
    for(var i=0;i<paramarr.length;i++){
      var arr = paramarr[i].split("=");
      if(arr[0] == "access_code"){
        access_code = arr[1];
      }
    }
    if(access_code == ""){
      alert("Restricted access! Navigating to plans page.");
      location.assign("plans.html");
    }

    $(document).ready(()=>{
      function render_plan_files(files){
        var table = document.querySelector("#plan-files");
        for(var i=0;i<files.length;i++){
          var tr = document.createElement("tr");
          var td1 = document.createElement("td");
          $(td1).text(files[i].id);
          tr.append(td1);
          var td2 = document.createElement("td");
          $(td2).text(files[i].file);
          tr.append(td2);
          var td3 = document.createElement("td");
          $(td3).html("<a href='"+files[i].file+"' download>Download</a>");
          tr.append(td3);

          table.append(tr);
        }
      }
      function get_plan_files(plan_id){
        $.get("/api/sale.php?type=plan_files&access_code="+access_code, (data)=>{
          if(data.length==0){
              alert("No plan files available");
          } else {
            render_plan_files(data);
          }
        });
      }

      function render_plan_pictures(pictures){
        var container = document.querySelector("#plan-pictures");
        for(var i=0;i<pictures.length;i++){
          var div = document.createElement("div");
          div.classList.add("col");
          var img = new Image();
          img.src=pictures[i].picture;
          div.append(img);
          container.append(div);
        }
      }
      function get_plan_pictures(plan){
        $.get("/api/plan.php?type=all_picture&plan_id="+plan.id, (data)=>{
          render_plan_pictures(data);
        });
      }

      function render_plan(plan){
        document.querySelector("#plan-picture").src = plan.picture;
        $("#plan-description").html(plan.description);
        $("#plan-price").html("<b>K"+plan.price+"</b>");
        $(".input-plan-id").val(plan.id);
        $(".text-plan-id").text(plan.id);

        //get_plan_files(plan);
        //get_plan_pictures(plan);
      }

      
        function render_sale(sale){
            $(".input-sale-id").val(sale.id);
            $(".text-sale-id").text(sale.id);
            $(".text-sale-phone").text(sale.phone);
            $(".text-sale-alt_phone").text(sale.alt_phone);
            $(".text-sale-status").text(sale.status);
            $(".text-sale-access_code").text(sale.access_code);
        }

      $.get("/api/sale.php?type=plan_files&access_code="+access_code, (data)=>{
        if(data.hasOwnProperty("message")){
            alert(data.message);
            location.assign("plans.html");
        } else {
            get_plan_files();
        }
      });
      $.get("/api/sale.php?type=sale&access_code="+access_code, (data)=>{
        render_sale(data);
      });
    });
    </script>

    <footer>
      <h2>Social Links</h2>
      <a href="#" class="btn">Facebook</a>
      <a href="#" class="btn">Tweeter</a>
      <a href="#" class="btn">YouTube</a>
      <div class="bar">
        &copy; Imagery 2021, proudly designed by <a href="https://linkedin.com/in/fshangala">fshangala</a>
      </div>
    </footer>

    <!--Imagery javascript-->
    <script src="assets/js/main.js"></script>
  </body>
</html>